name: Build and Release Add-on

on:
  release:
    types: [published]
    workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Download Wheel from PhotoshopAPI
        uses: robinraju/release-downloader@v1.8
        with:
          repository: 'heinn-dev/PhotoshopAPI'
          latest: true
          fileName: '*.whl'
          out-file-path: 'wheels/'
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Stage Add-on Files
        run: |
          mkdir release_stage
          mkdir release_stage/blender_psd
          
          # Copy everything from current dir to the stage dir
          # Excluding the .git folder and the staging folder itself
          rsync -av --progress . release_stage/blender_psd --exclude .git --exclude .github --exclude release_stage

      - name: Zip Add-on
        run: |
          cd release_stage
          zip -r ../blender_psd_addon.zip blender_psd/

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: blender_psd_addon.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}